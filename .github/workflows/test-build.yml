# Test build for pull requests
#
# This workflow runs on pull requests to ensure the site builds
# successfully before merging to main branch.
#
name: Test Build

on:
  # Run on pull requests targeting main branch
  pull_request:
    branches: [ "main" ]
  
  # Allow manual triggering from Actions tab
  workflow_dispatch:

# Standard permissions for testing
permissions:
  contents: read

jobs:
  # Test build job
  test-build:
    name: Test build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          npm ci
          echo "âœ… Dependencies installed successfully"
      
      - name: Lint and validate configuration
        run: |
          echo "ğŸ” Validating package.json..."
          npm run --silent || echo "No test script defined"
          
          echo "ğŸ” Checking for common issues..."
          # Check if required files exist
          test -f .eleventy.js || (echo "âŒ .eleventy.js not found" && exit 1)
          test -f package.json || (echo "âŒ package.json not found" && exit 1)
          
          echo "âœ… Configuration validation passed"
      
      - name: Test build
        run: |
          echo "ğŸ”¨ Testing Eleventy build with Sass preprocessing..."
          npm run build
          echo "âœ… Test build completed successfully"
        env:
          NODE_ENV: test
      
      - name: Verify build artifacts
        run: |
          echo "ğŸ“‹ Build verification:"
          
          # Check if _site directory was created
          test -d _site || (echo "âŒ _site directory not created" && exit 1)
          
          # Check if index.html exists
          test -f _site/index.html || (echo "âŒ index.html not found in _site" && exit 1)
          
          # Check if CSS was compiled
          find _site -name "*.css" | grep -q . || (echo "âŒ No CSS files found in build" && exit 1)
          
          echo "ğŸ“Š Site structure:"
          ls -la _site/
          
          echo "ğŸ“ HTML files:"
          find _site -name "*.html" | head -10
          
          echo "ğŸ¨ CSS files:"
          find _site -name "*.css"
          
          echo "âœ… All build artifacts verified successfully"
      
      - name: Check for broken internal links (basic)
        run: |
          echo "ğŸ”— Basic link validation..."
          # Simple check for common issues in HTML files
          if find _site -name "*.html" -exec grep -l 'href=""' {} \; | head -1; then
            echo "âš ï¸  Found empty href attributes"
          fi
          
          if find _site -name "*.html" -exec grep -l 'src=""' {} \; | head -1; then
            echo "âš ï¸  Found empty src attributes"
          fi
          
          echo "âœ… Basic link validation completed"